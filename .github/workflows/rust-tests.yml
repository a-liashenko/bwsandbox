name: Rust tests

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR num"
        required: false
        type: string
      branch_name:
        description: "Branch name"
        required: false
        type: string
  push:
    branches:
      - main

jobs:
  build-checks:
    name: Check, audit && linting
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.pr_number && format('refs/pull/{0}/head', inputs.pr_number) || inputs.branch_name || github.ref }}

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y libseccomp-dev

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          components: clippy

      - name: Cargo check
        run: cargo check --all-features

      - name: Cargo clippy
        run: cargo clippy --all-features

      - name: Cargo audit
        uses: rustsec/audit-check@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  # Run tests on self-hosted runner to have access to slirp4netns, bwrap and etc
  full-tests:
    name: Tests
    runs-on: [self-hosted, Linux, vps-03]
    timeout-minutes: 30
    needs: build-checks
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.pr_number && format('refs/pull/{0}/head', inputs.pr_number) || inputs.branch_name || github.ref }}

      - name: Run tests (including slirp4netns and etc)
        run: cargo test --release
